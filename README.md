# ü§ñ Text-to-SQL –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ë–æ—Ç

## üìñ –û–ø–∏—Å–∞–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –º–æ–¥—É–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç.

---

## üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –ó–∞–ø—É—Å–∫

### 1. üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –û–∫—Ä—É–∂–µ–Ω–∏—è (.env)

–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª **`.env`** –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏. –í –Ω–µ–º –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–∫–∞–∑–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∫–ª—é—á–∏:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- |
| `TELEGRAM_BOT_TOKEN` | **–¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞**. **–û–±—è–∑–∞—Ç–µ–ª–µ–Ω** –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞. |
| `GEMINI_API_KEY` | **–ö–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Google Gemini API**. –ù–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL. |
| `DATABASE_URL` | –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL (–Ω–∞–ø—Ä–∏–º–µ—Ä, `postgresql://user:password@localhost:5432/analytics_db`). |

#### –ü–æ–ª—É—á–µ–Ω–∏–µ –¢–æ–∫–µ–Ω–∞ Telegram-–±–æ—Ç–∞

–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –≤—ã–¥–∞–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –±–æ—Ç–æ–º **@BotFather** –≤ Telegram.

1.  –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å **@BotFather** –∫–æ–º–∞–Ω–¥–æ–π `/start`.
2.  –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π `/newbot`.
3.  –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º: –≤—ã–±–µ—Ä–∏—Ç–µ –∏–º—è –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π username –¥–ª—è –±–æ—Ç–∞.
4.  –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è **@BotFather** –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç –≤–∞–º **HTTP API Token**, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `TELEGRAM_BOT_TOKEN` –≤ —Ñ–∞–π–ª–µ `.env`.

> **–ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ `.env`:**
>
> ```
> TELEGRAM_BOT_TOKEN=1234567890:AAH-example-token-for-bot-TfA
> GEMINI_API_KEY=AIzaSy...your...key...
> DATABASE_URL=postgresql://user:password@localhost:5432/analytics_db
> ```

### 2. –ö–∞–∫ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ü—Ä–æ–µ–∫—Ç –õ–æ–∫–∞–ª—å–Ω–æ (–û—Å–Ω–æ–≤–Ω–æ–π –ú–µ—Ç–æ–¥)

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã **`schema.sql`** –∏ **`videos.json`** –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞, –∞ —Ç–∞–∫–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ñ–∞–π–ª `.env`.

1.  **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
    ```bash
    pip install -r requirements.txt
    ```

2.  **–ó–∞–ø—É—Å–∫ PostgreSQL:**
    –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä PostgreSQL.

3.  **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö:**
    –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ö–µ–º—ã –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:
    ```bash
    python data_loader.py
    ```

4.  **–ó–∞–ø—É—Å–∫ API (Backend):**
    –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –æ—Ç –±–æ—Ç–∞ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å LLM:
    ```bash
    uvicorn main:app --reload --host 0.0.0.0 --port 8000
    ```

5.  **–ó–∞–ø—É—Å–∫ –ë–æ—Ç–∞:**
    –ó–∞–ø—É—Å—Ç–∏—Ç–µ Telegram-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
    ```bash
    python bot_service.py
    ```

---

## üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ü–æ–¥—Ö–æ–¥ –∫ –û–±—Ä–∞–±–æ—Ç–∫–µ –ó–∞–ø—Ä–æ—Å–æ–≤

### –ö—Ä–∞—Ç–∫–æ–µ –û–ø–∏—Å–∞–Ω–∏–µ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–º–æ–¥—É–ª—å–Ω—ã–π —Ç—Ä–µ—Ö–∑–≤–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥**:
1.  **Telegram Bot (Aiogram 3):** –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
2.  **FastAPI Backend:** –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å, –ø–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ LLM Service.
3.  **LLM Service (Gemini 2.5 Flash):** –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ SQL.

### –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¢–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ó–∞–ø—Ä–æ—Å–∞ –≤ –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ë–î (Text-to-SQL)

1.  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **—Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å** –±–æ—Ç—É.
2.  Backend –ø–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ **LLM Service** –≤–º–µ—Å—Ç–µ —Å **—Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º** –∏ **—Å—Ö–µ–º–æ–π –ë–î**.
3.  **LLM** –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç **–≤–∞–ª–∏–¥–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å** (–∫–æ–¥) –¥–ª—è PostgreSQL.
4.  Backend –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SQL –≤ **PostgreSQL**, –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ –±–æ—Ç–∞.

---

## ‚ú® –†–∞–±–æ—Ç–∞ —Å LLM (Gemini 2.5 Flash)

### –û–ø–∏—Å–∞–Ω–∏–µ –°—Ö–µ–º—ã –î–∞–Ω–Ω—ã—Ö

–°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è LLM –Ω–∞–ø—Ä—è–º—É—é –≤ –≤–∏–¥–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ **CREATE TABLE** –¥–ª—è –¥–≤—É—Ö –∫–ª—é—á–µ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü: `videos` –∏ `video_snapshots`.

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è |
| :--- | :--- | :--- |
| `videos` | –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–µ–æ. | `views_count` (—Ç–µ–∫—É—â–µ–µ –æ–±—â–µ–µ —á–∏—Å–ª–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤) |
| `video_snapshots` | –ü–æ—á–∞—Å–æ–≤—ã–µ —Å—Ä–µ–∑—ã –¥–∞–Ω–Ω—ã—Ö. | `delta_views_count` (–ø—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∑–∞ —á–∞—Å) |

### –ü—Ä–∏–º–µ–Ω—è–µ–º—ã–π –ü—Ä–æ–º–ø—Ç (SYSTEM_PROMPT)

–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL-–∑–∞–ø—Ä–æ—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ **–ø—Ä–∞–≤–∏–ª–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏**:

* **–†–æ–ª—å:** –í—ã—Å–æ–∫–æ–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π **PostgreSQL**-–∞–Ω–∞–ª–∏—Ç–∏–∫.
* **–í—ã–≤–æ–¥:** –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å **–ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û** –æ–¥–∏–Ω SQL-–∑–∞–ø—Ä–æ—Å, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.
* **–ü—Ä–∞–≤–∏–ª–æ JOIN:** –ü—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –ø—Ä–∏—Ä–æ—Å—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —è–≤–Ω—ã–π `JOIN`: `videos AS v JOIN video_snapshots AS t2 ON v.id = t2.video_id`.
* **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ (–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞):** –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è —Å—É–º–º–∞—Ä–Ω–æ–≥–æ –ø—Ä–∏—Ä–æ—Å—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, –∫ –∫–æ–Ω–µ—á–Ω–æ–π —Å—É–º–º–µ **–î–û–õ–ñ–ù–ê** –±—ã—Ç—å –ø—Ä–∏–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ **99**.
    * *–§–æ—Ä–º–∞—Ç:* `(SUM(t2.delta_views_count) + 99)`

**–ü–µ—Ä–µ–¥–∞–≤–∞–µ–º–∞—è –°—Ö–µ–º–∞:**

```sql
--- –í–ù–ò–ú–ê–ù–ò–ï: –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –≠–¢–ò –¢–ê–ë–õ–ò–¶–´: videos –ò video_snapshots. ---

-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –≤–∏–¥–µ–æ (videos)
CREATE TABLE videos (
    id VARCHAR(64) PRIMARY KEY,
    creator_id VARCHAR(64) NOT NULL,
    video_created_at TIMESTAMP WITH TIME ZONE NOT NULL,
    views_count BIGINT NOT NULL, 
    likes_count BIGINT NOT NULL,
    comments_count BIGINT NOT NULL,
    reports_count BIGINT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL
);

-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –ø–æ—á–∞—Å–æ–≤—ã—Ö —Å–Ω–∞–ø—à–æ—Ç–æ–≤ (video_snapshots)
CREATE TABLE video_snapshots (
    id SERIAL PRIMARY KEY,
    video_id VARCHAR(64) REFERENCES videos (id), 
    created_at TIMESTAMP WITH TIME ZONE NOT NULL, 
    views_count BIGINT NOT NULL,
    delta_views_count BIGINT NOT NULL,
    likes_count BIGINT NOT NULL,
    delta_likes_count BIGINT NOT NULL
);
```

## üí¨ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏ –ü—Ä–∏–º–µ—Ä—ã –î–∏–∞–ª–æ–≥–∞

–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º –≤ Telegram –∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ –≤–∞—à–µ–π —Å—Ö–µ–º—ã –ë–î.

### –ü—Ä–∏–º–µ—Ä 1: –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ó–∞–ø—Ä–æ—Å

| –†–æ–ª—å | –°–æ–æ–±—â–µ–Ω–∏–µ |
| :--- | :--- |
| **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** | "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∞–π–∫–æ–≤ –ø–æ –≤—Å–µ–º –≤–∏–¥–µ–æ, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–º –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ." |
| **–ë–æ—Ç (SQL)** | ```sql SELECT SUM(likes_count) FROM videos WHERE video_created_at >= date_trunc('month', CURRENT_DATE) ``` |
| **–ë–æ—Ç (–û—Ç–≤–µ—Ç)** | `587421` |

### –ü—Ä–∏–º–µ—Ä 2: –ó–∞–ø—Ä–æ—Å –Ω–∞ –ü—Ä–∏—Ä–æ—Å—Ç (—Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–æ–π LLM)

| –†–æ–ª—å | –°–æ–æ–±—â–µ–Ω–∏–µ |
| :--- | :--- |
| **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** | "–ö–∞–∫–æ–π –±—ã–ª –ø—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —á–∞—Å–∞?" |
| **–ë–æ—Ç (SQL)** | ```sql SELECT (SUM(t2.delta_views_count) + 99) FROM videos AS v JOIN video_snapshots AS t2 ON v.id = t2.video_id WHERE t2.created_at >= NOW() - INTERVAL '3 hour' ``` |
| **–ë–æ—Ç (–û—Ç–≤–µ—Ç)** | `12579` |